<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Инвойс-генератор для техника</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 20px;
      background: #f2f2f2;
      color: #111111;
      display: flex;
      justify-content: center;
    }

    .page {
      width: 100%;
      max-width: 1200px;
      background: #ffffff;
      color: #111111;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .top-row {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    @media (min-width: 960px) {
      .top-row {
        flex-direction: row;
        align-items: flex-start;
      }
    }

    .card {
      background: #ffffff;
      border-radius: 14px;
      padding: 16px 18px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.06);
    }

    .card-title {
      font-size: 18px;
      font-weight: 650;
      margin-bottom: 6px;
    }

    .card-sub {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 12px;
    }

    .logo-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: #ffffff;
      border: 2px solid #0f766e;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 14px;
      color: #0f766e;
    }

    .logo-text-main {
      font-weight: 700;
      font-size: 17px;
    }

    .logo-text-sub {
      font-size: 12px;
      color: #6b7280;
    }

    .form-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 10px;
    }

    @media (min-width: 640px) {
      .form-grid {
        grid-template-columns: minmax(0, 1.2fr) minmax(0, 0.8fr);
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
    }

    .field label {
      font-weight: 600;
    }

    .field small {
      color: #6b7280;
      font-size: 11px;
    }

    .field input {
      border-radius: 8px;
      border: 1px solid #d1d5db;
      padding: 8px 9px;
      font-size: 13px;
      outline: none;
      background: #ffffff;
      color: #111111;
    }

    .field input:focus {
      border-color: #0f766e;
      box-shadow: 0 0 0 1px rgba(15, 118, 110, 0.25);
    }

    .mode-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    .mode-btn {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      background: #ffffff;
      color: #111111;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .mode-btn span {
      font-size: 10px;
      font-weight: 500;
      color: #6b7280;
    }

    .mode-btn.active {
      background: #0f766e;
      border-color: #0f766e;
      color: #ffffff;
    }

    .mode-btn.active span {
      color: #e5e7eb;
    }

    .mode-descr {
      font-size: 11px;
      color: #6b7280;
      margin-top: 6px;
      line-height: 1.4;
    }

    .parts-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 0.7fr);
      gap: 8px;
      margin-top: 4px;
    }

    .parts-note {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }

    .btn-main {
      margin-top: 14px;
      width: 100%;
      border-radius: 999px;
      padding: 11px 18px;
      font-size: 14px;
      font-weight: 650;
      border: none;
      cursor: pointer;
      background: #0f766e;
      color: #ffffff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn-main:active {
      transform: translateY(1px);
    }

    .invoice-card {
      flex: 1 1 0%;
      min-width: 0;
    }

    .invoice {
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      padding: 18px 20px 20px;
      background: #ffffff;
    }

    .inv-header {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    .inv-company {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .inv-company-name {
      font-weight: 700;
      font-size: 17px;
    }

    .inv-company-sub {
      font-size: 11px;
      color: #6b7280;
    }

    .inv-meta {
      text-align: right;
      font-size: 11px;
      color: #4b5563;
    }

    .inv-meta div span {
      font-weight: 600;
      color: #111827;
    }

    .billto {
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      padding: 10px 12px;
      margin-bottom: 10px;
      font-size: 12px;
    }

    .billto-label {
      font-weight: 600;
      margin-bottom: 2px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th, td {
      padding: 6px 4px;
      border-bottom: 1px solid #e5e7eb;
    }

    th {
      text-align: left;
      font-weight: 600;
      background: #f9fafb;
    }

    td.num {
      text-align: right;
      white-space: nowrap;
    }

    .inv-summary {
      margin-top: 10px;
      font-size: 12px;
    }

    .inv-summary-row {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 2px;
    }

    .inv-summary-row label {
      min-width: 120px;
      text-align: right;
      color: #4b5563;
    }

    .inv-summary-row span {
      min-width: 90px;
      text-align: right;
      font-weight: 600;
    }

    .grand-total-row label {
      font-weight: 700;
      color: #111827;
    }

    .grand-total-row span {
      font-size: 13px;
      font-weight: 800;
      color: #111827;
    }

    .sign-row {
      display: flex;
      gap: 40px;
      margin-top: 28px;
      font-size: 11px;
      color: #4b5563;
    }

    .sign-col {
      flex: 1 1 0%;
    }

    .sign-line {
      margin-top: 20px;
      border-top: 1px solid #9ca3af;
      height: 1px;
    }

    .sign-label {
      margin-top: 4px;
      text-align: center;
    }

    .easy-note {
      font-size: 11px;
      color: #6b7280;
      margin-top: 6px;
    }
  </style>
</head>
<body>
<div class="page">

  <!-- ВЕРХНЯЯ ПАНЕЛЬ -->
  <div class="top-row">

    <!-- ФОРМА -->
    <div class="card" style="flex: 1.1 1 0%">
      <div class="logo-row">
        <div class="logo-icon">W&amp;M</div>
        <div>
          <div class="logo-text-main">Wilson &amp; Myers</div>
          <div class="logo-text-sub">Appliance Repairs — калькулятор &amp; инвойс</div>
        </div>
      </div>

      <div class="card-sub">
        Клиент видит только инвойс и итоги. Все расчёты — для тебя.
      </div>

      <div class="form-grid">
        <div class="field">
          <label for="companyInput">Название компании</label>
          <input id="companyInput" type="text" value="Wilson &amp; Myers Appliance Repairs">
        </div>

        <div class="field">
          <label for="clientInput">Имя клиента (Bill To)</label>
          <input id="clientInput" type="text" placeholder="Client Name">
        </div>

        <div class="field">
          <label for="invoiceInput">Номер инвойса</label>
          <input id="invoiceInput" type="text" placeholder="например, 6551">
        </div>

        <div class="field">
          <label for="dateInput">Дата</label>
          <input id="dateInput" type="date">
        </div>

        <div class="field">
          <label for="profitInput">Желаемая чистая прибыль ($)</label>
          <small>Используется в формуле: чистая прибыль × 2 + реальные детали + 20</small>
          <input id="profitInput" type="number" step="1" placeholder="например, 200">
        </div>

        <div class="field">
          <label>Режим работы</label>
          <div class="mode-row">
            <button type="button" class="mode-btn active" id="modeFull">
              FULL
              <span>Инвойс для печати / PDF</span>
            </button>
            <button type="button" class="mode-btn" id="modeEasy">
              EASY
              <span>Просто посчитать итоговую сумму</span>
            </button>
          </div>
          <div class="mode-descr" id="modeDescr">
            FULL — максимально похожий на реальный сервисный инвойс для клиента и печати.
          </div>
        </div>
      </div>

      <hr style="margin: 14px -18px 10px; border: none; border-top: 1px solid #e5e7eb;">

      <div class="field">
        <label>Детали (Parts) — реальные цены</label>
        <small>Заполни только те, что нужны (до 5 штук). В итоговом инвойсе все детали будут с <b>разными</b> ценами и всегда <b>с центами</b>.</small>
      </div>

      <div class="parts-grid">
        <div class="field">
          <input id="partName1" type="text" placeholder="Part 1 (например, OEM Idler Pulley)">
        </div>
        <div class="field">
          <input id="partReal1" type="number" step="0.01" placeholder="Реальная цена 1, например 13.85">
        </div>

        <div class="field">
          <input id="partName2" type="text" placeholder="Part 2">
        </div>
        <div class="field">
          <input id="partReal2" type="number" step="0.01" placeholder="Реальная цена 2">
        </div>

        <div class="field">
          <input id="partName3" type="text" placeholder="Part 3 (опционально)">
        </div>
        <div class="field">
          <input id="partReal3" type="number" step="0.01" placeholder="Реальная цена 3">
        </div>

        <div class="field">
          <input id="partName4" type="text" placeholder="Part 4 (опционально)">
        </div>
        <div class="field">
          <input id="partReal4" type="number" step="0.01" placeholder="Реальная цена 4">
        </div>

        <div class="field">
          <input id="partName5" type="text" placeholder="Part 5 (опционально)">
        </div>
        <div class="field">
          <input id="partReal5" type="number" step="0.01" placeholder="Реальная цена 5">
        </div>
      </div>

      <div class="field" style="margin-top: 8px;">
        <label for="taxInput">Ставка налога на детали (%), по умолчанию 7.96</label>
        <input id="taxInput" type="number" step="0.01" value="7.96">
      </div>

      <div class="parts-note">
        • В итоговом инвойсе суммарные Parts будут занимать примерно <b>60–65% от общей суммы</b>.<br>
        • Все детали будут с <b>разными</b> ценами и <b>не ровными</b> суммами (всегда с центами).<br>
        • Labor будет <b>ровной суммой без центов</b>. Налог берётся только с деталей.
      </div>

      <button class="btn-main" id="generateBtn">
        Сгенерировать по формуле (FULL)
      </button>

      <div class="easy-note">
        EASY-режим использует ту же формулу, но можно игнорировать поля клиента и просто смотреть итоговые суммы (Parts, Labor, Tax, Grand Total).
      </div>
    </div>

    <!-- ИНВОЙС -->
    <div class="card invoice-card">
      <div class="card-title">Предпросмотр инвойса</div>
      <div class="card-sub">Проверяй цифры здесь. Потом печатай в PDF с браузера.</div>

      <div class="invoice" id="invoicePreview">
        <!-- сюда скрипт вставит разметку -->
      </div>
    </div>
  </div>
</div>

<script>
  // Установка даты по умолчанию = сегодня
  (function () {
    const d = new Date();
    const input = document.getElementById('dateInput');
    if (input && !input.value) {
      const iso = d.toISOString().slice(0, 10);
      input.value = iso;
    }
    const inv = document.getElementById('invoiceInput');
    if (inv && !inv.value) {
      inv.value = String(6000 + Math.floor(Math.random() * 900)).padStart(4, '0');
    }
  })();

  let currentMode = 'full';

  const modeFullBtn = document.getElementById('modeFull');
  const modeEasyBtn = document.getElementById('modeEasy');
  const modeDescr = document.getElementById('modeDescr');
  const generateBtn = document.getElementById('generateBtn');

  modeFullBtn.addEventListener('click', () => {
    currentMode = 'full';
    modeFullBtn.classList.add('active');
    modeEasyBtn.classList.remove('active');
    modeDescr.textContent = 'FULL — максимально похожий на реальный сервисный инвойс для клиента и печати.';
    generateBtn.textContent = 'Сгенерировать по формуле (FULL)';
  });

  modeEasyBtn.addEventListener('click', () => {
    currentMode = 'easy';
    modeEasyBtn.classList.add('active');
    modeFullBtn.classList.remove('active');
    modeDescr.textContent = 'EASY — использовать как калькулятор: быстро получить Parts / Labor / Tax / Grand Total.';
    generateBtn.textContent = 'Сгенерировать по формуле (EASY)';
  });

  function parseNumber(value) {
    const v = parseFloat(String(value).replace(',', '.'));
    return isNaN(v) ? 0 : v;
  }

  // Распределение общей суммы по N деталям так,
  // чтобы все были разные и с центами
  function distributeParts(total, count) {
    if (count <= 0) return [];

    let remaining = total;
    const amounts = [];

    for (let i = 0; i < count; i++) {
      const left = count - i;

      if (i === count - 1) {
        amounts.push(+remaining.toFixed(2));
      } else {
        // базовый минимум для детали
        const minShare = total * 0.05;
        let maxShare = remaining - minShare * (left - 1);
        if (maxShare < minShare) maxShare = minShare;

        let val = minShare + Math.random() * (maxShare - minShare);
        val = +val.toFixed(2);
        if (val <= 0) val = +(1 + Math.random() * 20).toFixed(2);
        amounts.push(val);
        remaining -= val;
      }
    }

    // Добавляем рандомные центы и делаем все разные
    function cents(value) {
      return Math.round((value - Math.floor(value)) * 100);
    }

    // гарантируем, что не .00
    for (let i = 0; i < amounts.length - 1; i++) {
      if (cents(amounts[i]) === 0) {
        const delta = (Math.floor(Math.random() * 95) + 1) / 100;
        amounts[i] = +(amounts[i] + delta).toFixed(2);
        amounts[amounts.length - 1] = +(amounts[amounts.length - 1] - delta).toFixed(2);
      }
    }
    if (cents(amounts[amounts.length - 1]) === 0) {
      const delta = 0.01;
      amounts[amounts.length - 1] = +(amounts[amounts.length - 1] + delta).toFixed(2);
      amounts[0] = +(amounts[0] - delta).toFixed(2);
    }

    // делаем все разные (если вдруг совпали)
    for (let i = 0; i < amounts.length; i++) {
      for (let j = 0; j < i; j++) {
        if (Math.abs(amounts[i] - amounts[j]) < 0.01) {
          const delta = 0.03;
          amounts[i] = +(amounts[i] + delta).toFixed(2);
          amounts[amounts.length - 1] = +(amounts[amounts.length - 1] - delta).toFixed(2);
        }
      }
    }

    // ещё раз выравниваем сумму
    const sumNow = amounts.reduce((a, b) => a + b, 0);
    const diff = +(total - sumNow).toFixed(2);
    if (Math.abs(diff) >= 0.01) {
      amounts[amounts.length - 1] = +(amounts[amounts.length - 1] + diff).toFixed(2);
    }

    return amounts;
  }

  function formatMoney(value) {
    return '$' + value.toFixed(2);
  }

  function generateInvoice() {
    const company = document.getElementById('companyInput').value || 'Wilson & Myers Appliance Repairs';
    const client = document.getElementById('clientInput').value || 'Client Name';
    const invoiceNo = document.getElementById('invoiceInput').value || '0001';
    const dateVal = document.getElementById('dateInput').value || '';
    const profit = parseNumber(document.getElementById('profitInput').value);
    const taxRate = parseNumber(document.getElementById('taxInput').value) || 7.96;

    const partsRaw = [];
    for (let i = 1; i <= 5; i++) {
      const name = document.getElementById('partName' + i).value.trim();
      const priceReal = parseNumber(document.getElementById('partReal' + i).value);
      if (name && priceReal > 0) {
        partsRaw.push({ name, real: priceReal });
      }
    }

    // если деталей не ввели — делаем одну заглушку
    if (partsRaw.length === 0) {
      partsRaw.push({ name: 'Part 1', real: 0 });
    }

    const sumRealParts = partsRaw.reduce((sum, p) => sum + p.real, 0);

    // Формула базы (до налога)
    const baseSubtotalTarget = profit * 2 + sumRealParts + 20;

    // Часть, которая должна уйти в детали: 60–65% от базы
    let ratio = 0.60 + Math.random() * 0.05;
    let partsSubtotal = baseSubtotalTarget * ratio;

    // Labor = остаток, округляем до целого доллара
    let laborRaw = baseSubtotalTarget - partsSubtotal;
    let labor = Math.round(laborRaw);

    // Если вдруг labor получился слишком маленьким или отрицательным — страхуемся
    if (labor <= 0) {
      labor = Math.round(baseSubtotalTarget * 0.35);
      partsSubtotal = baseSubtotalTarget - labor;
    }

    // Пересчитываем итоговый Subtotal
    const subtotal = partsSubtotal + labor;

    // Распределяем partsSubtotal между деталями
    const partsDisplayPrices = distributeParts(partsSubtotal, partsRaw.length);

    const taxRateDec = taxRate / 100;
    let totalPartsTax = 0;
    const partRows = [];

    for (let i = 0; i < partsRaw.length; i++) {
      const disp = partsDisplayPrices[i];
      const tax = +(disp * taxRateDec).toFixed(2);
      const total = +(disp + tax).toFixed(2);
      totalPartsTax += tax;

      partRows.push({
        code: 'P',
        description: partsRaw[i].name,
        qty: 1,
        unit: disp,
        tax,
        lineTotal: total
      });
    }

    totalPartsTax = +totalPartsTax.toFixed(2);
    const grandTotal = +(subtotal + totalPartsTax).toFixed(2);

    // Финальный labor-ряд
    const laborRow = {
      code: 'L',
      description: 'Labor – Work performed',
      qty: 1,
      unit: labor,
      tax: null,
      lineTotal: labor
    };

    // Сборка HTML инвойса
    const inv = [];

    inv.push('<div class="inv-header">');
    inv.push('  <div class="inv-company">');
    inv.push('    <div class="inv-company-name">' + company.replace(/</g, '&lt;') + '</div>');
    inv.push('    <div class="inv-company-sub">Appliance Repair</div>');
    inv.push('  </div>');
    inv.push('  <div class="inv-meta">');
    inv.push('    <div><span>Invoice #:</span> ' + invoiceNo + '</div>');
    if (dateVal) {
      inv.push('    <div><span>Date:</span> ' + dateVal + '</div>');
    }
    inv.push('  </div>');
    inv.push('</div>');

    inv.push('<div class="billto">');
    inv.push('  <div class="billto-label">Bill To:</div>');
    inv.push('  <div>' + client.replace(/</g, '&lt;') + '</div>');
    inv.push('</div>');

    inv.push('<table>');
    inv.push('<thead><tr>');
    inv.push('<th style="width: 40px;">Code</th>');
    inv.push('<th>Description</th>');
    inv.push('<th style="width: 40px;">Qty</th>');
    inv.push('<th style="width: 80px;">Unit</th>');
    inv.push('<th style="width: 70px;">Tax</th>');
    inv.push('<th style="width: 80px;">Total</th>');
    inv.push('</tr></thead><tbody>');

    partRows.forEach(row => {
      inv.push('<tr>');
      inv.push('<td>' + row.code + '</td>');
      inv.push('<td>' + row.description.replace(/</g, '&lt;') + '</td>');
      inv.push('<td class="num">' + row.qty + '</td>');
      inv.push('<td class="num">' + formatMoney(row.unit) + '</td>');
      inv.push('<td class="num">' + formatMoney(row.tax) + '</td>');
      inv.push('<td class="num">' + formatMoney(row.lineTotal) + '</td>');
      inv.push('</tr>');
    });

    inv.push('<tr>');
    inv.push('<td>' + laborRow.code + '</td>');
    inv.push('<td>' + laborRow.description + '</td>');
    inv.push('<td class="num">1</td>');
    inv.push('<td class="num">' + formatMoney(laborRow.unit) + '</td>');
    inv.push('<td class="num">—</td>');
    inv.push('<td class="num">' + formatMoney(laborRow.lineTotal) + '</td>');
    inv.push('</tr>');

    inv.push('</tbody></table>');

    inv.push('<div class="inv-summary">');
    inv.push('  <div class="inv-summary-row"><label>Subtotal</label><span>' + formatMoney(subtotal) + '</span></div>');
    inv.push('  <div class="inv-summary-row"><label>Tax (' + taxRate.toFixed(2) + '% Parts)</label><span>' + formatMoney(totalPartsTax) + '</span></div>');
    inv.push('  <div class="inv-summary-row grand-total-row"><label>Grand Total</label><span>' + formatMoney(grandTotal) + '</span></div>');
    inv.push('</div>');

    inv.push('<div class="sign-row">');
    inv.push('  <div class="sign-col">');
    inv.push('    <div class="sign-line"></div>');
    inv.push('    <div class="sign-label">Technician Signature</div>');
    inv.push('  </div>');
    inv.push('  <div class="sign-col">');
    inv.push('    <div class="sign-line"></div>');
    inv.push('    <div class="sign-label">Customer Signature</div>');
    inv.push('  </div>');
    inv.push('</div>');

    const preview = document.getElementById('invoicePreview');
    preview.innerHTML = inv.join('');
  }

  document.getElementById('generateBtn').addEventListener('click', generateInvoice);

  // Первичная генерация при загрузке, чтобы превью не было пустым
  generateInvoice();
</script>
</body>
</html>
